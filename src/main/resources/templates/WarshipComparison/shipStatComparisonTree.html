<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <script>
        //    <![CDATA[
        (function(w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({
                'gtm.start': new Date().getTime(),
                event:'gtm.js'
            });
            var f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5KDG7W6');
        //    ]]>
    </script>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta charset="UTF-8" />
    <link rel="icon" th:href="@{/images/Icon/WoWSFT_Icon.png}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/js/jquery/jquery-ui-1.12.1/jquery-ui.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/ShipStyle.css}" />
    <meta name="viewport" content="width=device-width, initial-scale=0.5, user-scalable=yes" />
    <script th:src="@{/js/jquery/jquery-3.2.1.js}"></script>
    <script th:src="@{/js/jquery/jquery-ui-1.12.1/jquery-ui.js}"></script>
    <script th:src="@{/js/accounting/accounting.js}"></script>
    <script>
        $(function() {
//            $(document).tooltip();

            $('#crewSkills').dialog({
                autoOpen: false,
//                modal: true,
                width: 860
            }).css("font-size", "8px");

            $('#flags').dialog({
                autoOpen: false,
//                modal: true,
                width: 650
            }).css("font-size", "8px");

//            $('#consumablesData').dialog({
//                autoOpen: false,
//                width: 320
//            }).css("font-size", "8px");
        });
    </script>
    <title>WoWS Fitting Tool by Aesis</title>
</head>
<body>
<noscript>
    //    <![CDATA[
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5KDG7W6" height="0" width="0" style="display:none; visibility:hidden;"></iframe>
    //    ]]>
</noscript>
<header>
    <div id="top" th:include="top :: top">
    </div>
</header>
<main>
    <div style="text-align: center;">
        <input type="text" id="shortenUrlAddress"/><button id="shortenURL">Shorten URL</button><br />
        <button th:each="nation : ${nations}" th:name="${nation.key}" th:class="button_nation">
            <img th:src="${'/images/Nations/' + nation.key + '.png'}"/><br />
            <th:block th:each="eNation : ${encyclopedia.ship_nations}" th:if="${nation.key == eNation.key}">
                <span th:text="${eNation.value}" />
            </th:block>
        </button>
    </div>
    <div style="text-align: center;">
        <button id="showCrewSkills">Commander Skills</button>
        <button id="showFlags">Flags</button>
        <input type="checkbox" id="camouflageCheckbox" th:checked="${camo}" th:text="'Camouflage'" th:title="'Decreases the firing accuracy of the enemy and reduces ship detectability.'"/>
        <!--<input type="checkbox" id="upgradeCompareCheckBox" th:text="'Upgrade Comparison'"/>-->
        <!--<br />-->
        <!--<button id="resetSelect">Reset</button><br />-->
    </div>
    <div style="text-align: center;">
        <div th:each="nation : ${nations}" th:id="${nation.key}" th:name="nations" hidden="hidden">
            <div th:class="shipTree" th:each="shipType : ${nation.value}" th:if="${shipType.key == 'AirCarrier'}">
                <li th:each="ship : ${shipType.value}" th:if="${shipStat.index + shipType.value.?[value.first == true].size() &lt; ship.value.maxTier}">
                    <button th:class="button_ship_tree_empty" disabled="disabled"></button>
                </li>
                <li th:each="ship : ${shipType.value}" th:if="${ship.value.first}">
                    <button th:class="${(ship1 != null and ship2 != null) and (ship1 == ship.value.name or ship2 == ship.value.name)} ? button_ship_tree_selected : button_ship_tree" th:id="${ship.key}" name="ship">
                        <img th:src="${ship.value.images.small}" th:title="${ship.value.name}"/><br />
                        <span th:text="${ship.value.tier + ' - ' + ship.value.name}"/><br />
                    </button>
                </li>
            </div>
            <div th:class="shipTree" th:each="shipType : ${nation.value}" th:if="${shipType.key == 'Battleship'}">
                <li th:each="ship : ${shipType.value}" th:if="${shipStat.index + shipType.value.?[value.first == true].size() &lt; ship.value.maxTier}">
                    <button th:class="button_ship_tree_empty" disabled="disabled"></button>
                </li>
                <li th:each="ship : ${shipType.value}" th:if="${ship.value.first}">
                    <button th:class="${(ship1 != null and ship2 != null) and (ship1 == ship.value.name or ship2 == ship.value.name)} ? button_ship_tree_selected : button_ship_tree" th:id="${ship.key}" name="ship">
                        <img th:src="${ship.value.images.small}" th:title="${ship.value.name}"/><br />
                        <span th:text="${ship.value.tier + ' - ' + ship.value.name}"/><br />
                    </button>
                </li>
            </div>
            <div th:class="shipTree" th:each="shipType : ${nation.value}" th:if="${shipType.key == 'Cruiser'}">
                <li th:each="ship : ${shipType.value}" th:if="${shipStat.index + shipType.value.?[value.first == true].size() &lt; ship.value.maxTier}">
                    <button th:class="button_ship_tree_empty" disabled="disabled"></button>
                </li>
                <li th:each="ship : ${shipType.value}" th:if="${ship.value.first}">
                    <button th:class="${(ship1 != null and ship2 != null) and (ship1 == ship.value.name or ship2 == ship.value.name)} ? button_ship_tree_selected : button_ship_tree" th:id="${ship.key}" name="ship">
                        <img th:src="${ship.value.images.small}" th:title="${ship.value.name}"/><br />
                        <span th:text="${ship.value.tier + ' - ' + ship.value.name}"/><br />
                    </button>
                </li>
            </div>
            <div th:class="shipTree" th:each="shipType : ${nation.value}" th:if="${shipType.key == 'Destroyer'}">
                <li th:each="ship : ${shipType.value}" th:if="${shipStat.index + shipType.value.?[value.first == true].size() &lt; ship.value.maxTier}">
                    <button th:class="button_ship_tree_empty" disabled="disabled"></button>
                </li>
                <li th:each="ship : ${shipType.value}" th:if="${ship.value.first}">
                    <button th:class="${(ship1 != null and ship2 != null) and (ship1 == ship.value.name or ship2 == ship.value.name)} ? button_ship_tree_selected : button_ship_tree" th:id="${ship.key}" name="ship">
                        <img th:src="${ship.value.images.small}" th:title="${ship.value.name}"/><br />
                        <span th:text="${ship.value.tier + ' - ' + ship.value.name}"/><br />
                    </button>
                </li>
            </div>
            <div th:class="shipTree" th:each="shipType : ${nation.value}" th:if="${shipType.key == 'Destroyer' and shipType.value.?[value.first == false].size() > 0}">
                <li th:each="ship : ${shipType.value}" th:if="${shipStat.index + shipType.value.?[value.first == false].size() &lt; ship.value.maxTier}">
                    <button th:class="button_ship_tree_empty" disabled="disabled"></button>
                </li>
                <li th:each="ship : ${shipType.value}" th:if="${!ship.value.first}">
                    <button th:class="${(ship1 != null and ship2 != null) and (ship1 == ship.value.name or ship2 == ship.value.name)} ? button_ship_tree_selected : button_ship_tree" th:id="${ship.key}" name="ship">
                        <img th:src="${ship.value.images.small}" th:title="${ship.value.name}"/><br />
                        <span th:text="${ship.value.tier + ' - ' + ship.value.name}"/><br />
                    </button>
                </li>
            </div>
            <table th:class="shipTree" th:each="pNation : ${premiumTable}" th:if="${pNation.key == nation.key}">
                <tr th:each="tier : ${pNation.value}">
                    <td th:if="${tier.value == null}">
                        <button th:class="button_ship_tree_empty" disabled="disabled"></button>
                    </td>
                    <td th:each="ship : ${tier.value}" th:if="${tier.value != null}">
                        <button th:class="${(ship1 != null and ship2 != null) and (ship1 == ship.value.name or ship2 == ship.value.name)} ? button_ship_tree_selected : button_ship_tree" th:id="${ship.key}" th:if="${ship.value.name != 'Test Ship'}" name="ship">
                            <img th:src="${ship.value.images.small}"/><br />
                            <span th:text="${ship.value.tier + ' - ' + ship.value.name}"/><br />
                        </button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div id="modulesUpgradesConsumables" th:include="WarshipComparison/shipStatSelection :: warshipSelection">
    </div>
    <div class="shipAPIData">
    </div>
</main>
<div id="crewSkills" class="ui-widget-content" title="Skill Points 0 / 19">
    <table id="skillsTable" align="center">
        <tbody>
        <tr th:each="skillTier : ${skills}">
            <td th:each="skill : ${skillTier.value}" th:id="${'td_' + skill.value.tier + '_' + skill.value.type_id}">
                <button th:if="${skill.value.tier != 0}" th:object="${skill.value}" th:title="${skill.value.description}" th:class="${crewSkills != null and crewSkills.size() != 0 and (crewSkills.?[tier == #strings.toString(__${skill.value.tier}__) and type_id == #strings.toString(__${skill.value.type_id}__)]).size() != 0} ? button_skill_selected : button_skill" th:id="${skill.value.tier + '_' + skill.value.type_id}" th:attr="tier=${skill.value.tier}, type_id=${skill.value.type_id}">
                    <img th:src="${skill.value.icon}"/><br />
                    <span th:text="${skill.value.name}"/>
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<div id="flags" class="ui-widget-content" title="Flags 0 / 8">
    <table id="flagsTable" align="center">
        <tbody>
        <tr th:each="index : ${#numbers.sequence(0, exteriors.Flags.size() - 1, 6)}" th:id="${index / 6}">
            <td th:each="flag : ${exteriors.Flags}" th:if="${flagStat.index % 3} == ${index / 6}">
                <button th:title="${flag.value.description}" th:class="${(flags != null and #sets.contains(flags, #strings.toString(flag.value.consumable_id)))} ? button_flag_selected : button_flag" th:id="${flag.value.consumable_id}">
                    <img th:src="${flag.value.image}"/><br />
                    <span th:text="${flag.value.name}"/>
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<script th:inline="javascript">
    //    <![CDATA[

    var live = [[${serverParam}]];

    var nation = '';

    var maxFlagPts = 8;

    var warship1Name = '';
    var warship1 = '';
    var warship2Name = '';
    var warship2 = '';

    var modules1 = [];
    var modules2 = [];
    var upgradesSkills = [];
    var upgradesSkillsV2 = {};
    var upgradesSkills1 = {};
    var upgradesSkills2 = {};
    var skills = [];
    var flags = [];
    var camouflage = [];
    var consumables1 = [[${consumables1}]] != null ? [[${consumables1}]] : [];
    var consumables2 = [[${consumables2}]] != null ? [[${consumables2}]] : [];
    var list1 = [[${consumables1}]] != null ? [[${consumables1}]] : [];
    var list2 = [[${consumables2}]] != null ? [[${consumables2}]] : [];
//    var selectedConsumables1 = [];
//    var selectedConsumables2 = [];
//    var notSelectedConsumables1 = [];
//    var notSelectedConsumables2 = [];

    var adrenalineValue1 = 100;
    var adrenalineValue2 = 100;

    var waitTime = 1000;
    var timer;

    $().ready(function () {
        if ([[${url}]] != null)
        {
            adrenalineValue1 = [[${adrenalineValue1}]];
            adrenalineValue2 = [[${adrenalineValue2}]];
            callAPI();
            setCaptainSkillPoints();
            setFlags();
        }
    });

    function setCaptainSkillPoints()
    {
        var list = $('.button_skill_selected');

        var maxSpts = 19;
        var totalSpts = 0;

        for (var i = 0; i < list.length; i++)
        {
            var current = list.eq(i);

            totalSpts = totalSpts + parseInt(current.attr('tier'));
        }

        $('[aria-describedby=crewSkills]').find('.ui-dialog-title').text('Skill Points ' + totalSpts.toString() + ' / ' + maxSpts.toString());
    }

    function setFlags()
    {
        var list = $('.button_flag_selected');

        if ([[${shipType}]] != null && [[${shipType}]] == 'AirCarrier')
        {
            maxFlagPts = 4;
        }

        var totalPts = list.length;

        $('[aria-describedby=flags]').find('.ui-dialog-title').text('Flags ' + totalPts.toString() + ' / ' + maxFlagPts.toString());
    }

    $(document).on('click', '.button_nation', function () {
        var name = $(this).attr('name');

        if ($('.shipAPIData').children().length != 0 && $('#' + name).attr('hidden') == undefined)
        {
            $('#' + name).attr('hidden', 'hidden');
            return;
        }

        $('[name=nations]').attr('hidden', 'hidden');
        $('#' + name).removeAttr('hidden');

        nation = name;
    });

    $(document).on('click', '.button_ship_tree', function () {
        var clickedId = $(this).attr('id');

        if ($('.button_ship_tree_selected').length == 2)
        {
            var selected = $('.button_ship_tree_selected');

            for (var i = 0; i < selected.length; i++)
            {
                var currentId = selected.eq(i).attr('id');
                document.getElementById(currentId).className = 'button_ship_tree';
            }
            // $('[aria-describedby=warship1]').remove();
            // $('[aria-describedby=warship2]').remove();
            // $('#modulesUpgradesConsumables').html('');
            // $('#shipAPIData').html('');
        }

        if ($('.button_ship_tree_selected').length < 2)
        {
            document.getElementById(clickedId).className = 'button_ship_tree_selected';
        }

        if ($('.button_ship_tree_selected').length == 2)
        {
            var selectedSkills = $('.button_skill_selected');
            for (var i = 0; i < selectedSkills.length; i++)
            {
                selectedSkills.eq(i).attr('class', 'button_skill');
            }

            var selectedFlags = $('.button_flag_selected');
            for (var i = 0; i < selectedFlags.length; i++)
            {
                selectedFlags.eq(i).attr('class', 'button_flag');
            }

//            $('#camouflageCheckbox').attr('checked', false);
            document.getElementById('camouflageCheckbox').checked = false;

            var selectedConsumables1 = $('.button_consumable_selected_1');
            for (var i = 0; i < selectedConsumables1.length; i++)
            {
                var current = selectedConsumables1.eq(i).attr('class');
                var abil = current.split(' ')[1];

                selectedConsumables1.eq(i).attr('class', 'button_consumable_1 ' + abil);
            }

            var selectedConsumables2 = $('.button_consumable_selected_2');
            for (var i = 0; i < selectedConsumables2.length; i++)
            {
                var current = selectedConsumables2.eq(i).attr('class');
                var abil = current.split(' ')[1];

                selectedConsumables2.eq(i).attr('class', 'button_consumable_2 ' + abil);
            }

            list1 = [];
            consumables1 = [];
            list2 = [];
            consumables2 = [];

            var list = [];
            var selected = $('.button_ship_tree_selected');
            for (var i = 0; i < selected.length; i++)
            {
                var current = selected.eq(i);
                var id = current.attr('id');
                list.push(id);
            }

            $.ajax({
                url: live + '/shipStatSelection',
                type: 'post',
                contentType: "application/json",
                data: JSON.stringify(list),
                success: function (data) {
                    // $('[aria-describedby=warship1]').remove();
                    // $('[aria-describedby=warship2]').remove();
                    $('[aria-describedby=artilleryCanvasDiv]').remove();
                    $('[aria-describedby=torpedoesCanvasDiv]').remove();
                    $('#shipAPIData').html('');
                    $('#modulesUpgradesConsumables').replaceWith(data);
                    callAPI()
                },
                error: function (data) {
                    console.log(data);
                    alert('Error - contact EdibleBug on Reddit')
                }
            });
        }
    });

    // $(document).on('click', '.button_ship_tree_selected', function () {
    //     var clickedId = $(this).attr('id');
    //
    //     document.getElementById(clickedId).className = 'button_ship_tree';
    //
    //     $('[aria-describedby=warship1]').remove();
    //     $('[aria-describedby=warship2]').remove();
    //     $('#modulesUpgradesConsumables').html('');
    // });

    // $(document).on('click', '#resetSelect', function () {
    //     var clickedList = $('.button_ship_tree_selected');
    //     for (var i = 0; i < clickedList.length; i++)
    //     {
    //         var clickedId = clickedList.eq(i).attr('id');
    //         document.getElementById(clickedId).className = 'button_ship_tree';
    //     }
    //
    //     var clickedSkillsList = $('.button_skill_selected');
    //     for (var i = 0; i < clickedSkillsList.length; i++)
    //     {
    //         var clickedId = clickedSkillsList.eq(i).attr('id');
    //         $('#' + clickedId).click();
    //     }
    //
    //     var clickedFlagsList = $('.button_flag_selected');
    //     for (var i = 0; i < clickedFlagsList.length; i++)
    //     {
    //         var clickedId = clickedFlagsList.eq(i).attr('id');
    //         $('#' + clickedId).click();
    //     }
    //
    //     $('[aria-describedby=warship1]').remove();
    //     $('[aria-describedby=warship2]').remove();
    //     $('#modulesUpgradesConsumables').html('');
    //     $('#shipAPIData').html('');
    // });

    $(document).on('click', '.button_module_1', function(){
        var clickedId = $(this).attr('id');
        var selectedModules = document.getElementsByName($(this).attr('name'));

        for (var i = 0; i < selectedModules.length; i++)
        {
            var buttonId = selectedModules[i].getAttribute('id').replace('li_', '');
            document.getElementById(buttonId).className = 'button_module_1';
        }
        document.getElementById(clickedId).className = 'button_module_selected_1';

        delayCall();
    });

    $(document).on('click', '.button_upgrade_1, .button_upgrade_selected_1', function () {
        var clickedId = $(this).attr('id');

        if (document.getElementById(clickedId).className == 'button_upgrade_1')
        {
            var gParentElem = $(this).parent().parent();
            var parents = gParentElem.children();

            for (var i = 0; i < parents.length; i++)
            {
                var buttonId = parents[i].getAttribute('id').replace('li_', '');
                document.getElementById(buttonId).className = 'button_upgrade_1';
            }
            document.getElementById(clickedId).className = 'button_upgrade_selected_1';
        }
        else
        {
            document.getElementById(clickedId).className = 'button_upgrade_1';
        }

        delayCall();
    });

    $(document).on('click', '.button_module_2', function(){
        var clickedId = $(this).attr('id');
        var selectedModules = document.getElementsByName($(this).attr('name'));

        for (var i = 0; i < selectedModules.length; i++)
        {
            var buttonId = selectedModules[i].getAttribute('id').replace('li_', '');
            document.getElementById(buttonId).className = 'button_module_2';
        }
        document.getElementById(clickedId).className = 'button_module_selected_2';

        delayCall();
    });

    $(document).on('click', '.button_upgrade_2, .button_upgrade_selected_2', function () {
        var clickedId = $(this).attr('id');

        if (document.getElementById(clickedId).className == 'button_upgrade_2')
        {
            var gParentElem = $(this).parent().parent();
            var parents = gParentElem.children();

            for (var i = 0; i < parents.length; i++)
            {
                var buttonId = parents[i].getAttribute('id').replace('li_', '');
                document.getElementById(buttonId).className = 'button_upgrade_2';
            }
            document.getElementById(clickedId).className = 'button_upgrade_selected_2';
        }
        else
        {
            document.getElementById(clickedId).className = 'button_upgrade_2';
        }

        delayCall();
    });

    $(document).on('click', '.button_skill, .button_skill_selected', function () {
        var maxSpts = 19;
        var currentSpts = 0;
        var clickedSpts = 0;
        var totalSpts = 0;

        var clickedId = $(this).attr('id');

        if (document.getElementById(clickedId).className == 'button_skill')
        {
            clickedSpts = clickedSpts + parseInt($(this).attr('tier'));
        }
        else
        {
            clickedSpts = clickedSpts - parseInt($(this).attr('tier'));
        }

        var selected = document.getElementsByClassName('button_skill_selected');

        for (var i = 0; i < selected.length; i++)
        {
            currentSpts = currentSpts + parseInt(selected[i].getAttribute('tier'));
        }

        totalSpts = totalSpts + currentSpts + clickedSpts;

        if (document.getElementById(clickedId).className == 'button_skill')
        {
            if (totalSpts > maxSpts)
            {
                return false;
            }
            document.getElementById(clickedId).className = 'button_skill_selected';
        }
        else
        {
            document.getElementById(clickedId).className = 'button_skill';
        }

        document.getElementById('ui-id-1').innerText = 'Skill Points ' + totalSpts.toString() + ' / ' + maxSpts.toString();

        delayCall();
    });

    $(document).on('click', '.button_flag, .button_flag_selected', function () {
        var maxFlags = 8;

        var clickedId = $(this).attr('id');
        var selected = document.getElementsByClassName('button_flag_selected');

        if (document.getElementById(clickedId).className == 'button_flag')
        {
            if (selected.length >= maxFlags)
            {
                return false;
            }
            document.getElementById(clickedId).className = 'button_flag_selected';
        }
        else
        {
            document.getElementById(clickedId).className = 'button_flag';
        }

        document.getElementById('ui-id-2').innerText = 'Flags ' + selected.length.toString() + ' / ' + maxFlags;

        delayCall();
    });

    $(document).on('click', '#showCrewSkills', function () {
        $('#crewSkills').dialog('open');
    });

    $(document).on('click', '#showFlags', function () {
        $('#flags').dialog('open');
    });

    $(document).on('click', '#camouflageCheckbox', function () {
        delayCall();
    });

    $(document).on('click', '#showArtillerySector', function () {
        $('#artilleryCanvasDiv').dialog('open');
    });

    $(document).on('click', '#showTorpedoSector', function () {
        $('#torpedoesCanvasDiv').dialog('open');
    });

    function delayCall()
    {
        window.clearTimeout(timer);
        timer = window.setTimeout(function() {
            callAPI();
        }, waitTime);
    }

    function callAPI()
    {
        $('[aria-describedby=artilleryCanvasDiv]').remove();
        $('[aria-describedby=torpedoesCanvasDiv]').remove();

        var modifier = '&';
        var equals = '=';

        var selectedSkills = $('.button_skill_selected');
        var selectedFlags = $('.button_flag_selected');
        skills = [];
        flags = [];
        upgradesSkills = [];
        upgradesSkillsV2 = {};

        for (var i = 0; i < selectedSkills.length; i++)
        {
            var tier = selectedSkills[i].getAttribute('tier');
            var type_id = selectedSkills[i].getAttribute('type_id');

            var current = {
                tier: tier,
                type_id: type_id
            };

            skills.push(current);
        }

        for (var i = 0; i < selectedFlags.length; i++)
        {
            var flagId = selectedFlags[i].getAttribute('id');

            flags.push(flagId);
        }

        camouflage = [$('#camouflageCheckbox').is(':checked')];

        warship1Name = $('#warship1').attr('title');
        var warship1 = $('#warship1').attr('name');
        var selectedModules1 = $('.button_module_selected_1');
        var selectedUpgrades1 = $('.button_upgrade_selected_1');

        modules1 = [];
        var upgrades1 = [];

        for (var i = 0; i < selectedModules1.length; i++)
        {
            var type = selectedModules1[i].getAttribute('name');
            var moduleId = selectedModules1[i].getAttribute('id');

            modules1.push(moduleId);

            warship1 = warship1 + modifier + type + equals + moduleId;
        }

        warship1 = warship1 + '&adrenalineValue1=' + adrenalineValue1;

        for (var i = 0; i < selectedUpgrades1.length; i++)
        {
            var upgradeId = selectedUpgrades1[i].getAttribute('id').replace('_1', '');

            upgrades1.push(upgradeId);
        }

        upgradesSkills1 = {
            shipName: warship1Name,
            upgrades: upgrades1
        };

        warship2Name = $('#warship2').attr('title');
        var warship2 = $('#warship2').attr('name');
        var selectedModules2 = $('.button_module_selected_2');
        var selectedUpgrades2 = $('.button_upgrade_selected_2');

        modules2 = [];
        var upgrades2 = [];

        for (var i = 0; i < selectedModules2.length; i++)
        {
            var type = selectedModules2[i].getAttribute('name');
            var moduleId = selectedModules2[i].getAttribute('id');

            modules2.push(moduleId);

            warship2 = warship2 + modifier + type + equals + moduleId;
        }

        warship2 = warship2 + '&adrenalineValue2=' + adrenalineValue2;

        for (var i = 0; i < selectedUpgrades2.length; i++)
        {
            var upgradeId = selectedUpgrades2[i].getAttribute('id').replace('_2', '');

            upgrades2.push(upgradeId);
        }

        upgradesSkills2 = {
            shipName: warship2Name,
            upgrades: upgrades2
        };

        var selectedConsumables1 = $('.button_consumable_selected_1');
        var selectedConsumables2 = $('.button_consumable_selected_2');

        list1 = selectedConsumables1.length != 0 ? [] : list1;
        list2 = selectedConsumables2.length != 0 ? [] : list2;
        consumables1 = selectedConsumables1.length != 0 ? [] : list1;
        consumables2 = selectedConsumables2.length != 0 ? [] : list2;

        for (var i = 0; i < selectedConsumables1.length; i++)
        {
            var consumableId = selectedConsumables1.eq(i).attr('name');
            consumables1.push(consumableId);
            list1.push(consumableId);
        }

        for (var i = 0; i < selectedConsumables2.length; i++)
        {
            var consumableId = selectedConsumables2.eq(i).attr('name');
            consumables2.push(consumableId);
            list2.push(consumableId);
        }

        upgradesSkillsV2 = {
            upgradesSkills1: upgradesSkills1,
            upgradesSkills2: upgradesSkills2,
            skills: { skills: skills },
            flags: { flags: flags },
            camouflage: { camouflage: camouflage }
        };

        $.ajax({
            url: live + '/shipStatComparison?' + encodeURI(warship1) + '&' + encodeURI(warship2),
            type: 'post',
            contentType: "application/json",
            data: JSON.stringify(upgradesSkillsV2),
            success: function (data) {
                if (data != '')
                {
                    $('.shipAPIData').replaceWith(data);
                    $('[name=nations]').attr('hidden', 'hidden');

                    setConsumables1();
                    setConsumables2();

                    history.replaceState({
                        warship1: warship1Name,
                        warship2: warship2Name
                    }, warship1Name + warship2Name, live + '/shipStatComparison?ship1=' + encodeURIComponent(warship1Name) + '&ship2=' + encodeURIComponent(warship2Name) + '&modules1=' + modules1 + '&modules2=' + modules2 + '&upgrades1=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills1))) + '&upgrades2=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills2))) + '&consumables1=' + consumables1 + '&consumables2=' + consumables2 + '&skills=' + btoa(encodeURIComponent(JSON.stringify(skills))) + '&flags=' + flags + '&camo=' + camouflage[0] +'&adrenalineValue1=' + adrenalineValue1 + '&adrenalineValue2=' + adrenalineValue2);
                }
                else
                {
//                        alert('Wrong path of research!');
                }
            }
        });
    }

    $(document).on('click', '#shipAPI1Button', function () {
        $('#warship1').dialog('open');
    });

    $(document).on('click', '#shipAPI2Button', function () {
        $('#warship2').dialog('open');
    });

    $(document).on('click', '#shortenURL', function () {
        var longUrl = encodeURIComponent(window.location.href);

        $.ajax({
            url: '/shortenUrl',
            type: 'post',
            contentType: "application/json",
            data: longUrl,
            success: function (data) {
                $('#shortenUrlAddress').val(data);
            },
            error: function (data) {
                console.log(data);
            }
        });
    });

    $(document).on('click', '.button_consumable_1', function () {
        var id = $(this).attr('name');
        var abil = $(this).attr('class').split(' ')[1];
        var abilDot = '.' + abil;

        $('.consumablesStats1' + abilDot).attr('style', 'display: none');
        $('.button_consumable_selected_1' + abilDot).attr('class', 'button_consumable_1 ' + abil);

        $('#' + id).removeAttr('style');
        $('[name=' + id + ']').attr('class', 'button_consumable_selected_1 ' + abil);

        var selectedConsumables = $('.button_consumable_selected_1');
        consumables1 = [];
        for (var i = 0; i < selectedConsumables.length; i++)
        {
            var consumableId = selectedConsumables[i].getAttribute('name');

            consumables1.push(consumableId);
        }

        history.replaceState({
            warship1: warship1Name,
            warship2: warship2Name
        }, warship1Name + warship2Name, live + '/shipStatComparison?ship1=' + encodeURIComponent(warship1Name) + '&ship2=' + encodeURIComponent(warship2Name) + '&modules1=' + modules1 + '&modules2=' + modules2 + '&upgrades1=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills1))) + '&upgrades2=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills2))) + '&consumables1=' + consumables1 + '&consumables2=' + consumables2 + '&skills=' + btoa(encodeURIComponent(JSON.stringify(skills))) + '&flags=' + flags + '&camo=' + camouflage[0] +'&adrenalineValue1=' + adrenalineValue1 + '&adrenalineValue2=' + adrenalineValue2);
    });

    $(document).on('click', '.button_consumable_2', function () {
        var id = $(this).attr('name');
        var abil = $(this).attr('class').split(' ')[1];
        var abilDot = '.' + abil;

        $('.consumablesStats2' + abilDot).attr('style', 'display: none;');
        $('.button_consumable_selected_2' + abilDot).attr('class', 'button_consumable_2 ' + abil);

        $('#' + id).removeAttr('style');
        $('[name=' + id + ']').attr('class', 'button_consumable_selected_2 ' + abil);

        var selectedConsumables = $('.button_consumable_selected_2');
        consumables2 = [];
        for (var i = 0; i < selectedConsumables.length; i++)
        {
            var consumableId = selectedConsumables[i].getAttribute('name');

            consumables2.push(consumableId);
        }

        history.replaceState({
            warship1: warship1Name,
            warship2: warship2Name
        }, warship1Name + warship2Name, live + '/shipStatComparison?ship1=' + encodeURIComponent(warship1Name) + '&ship2=' + encodeURIComponent(warship2Name) + '&modules1=' + modules1 + '&modules2=' + modules2 + '&upgrades1=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills1))) + '&upgrades2=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills2))) + '&consumables1=' + consumables1 + '&consumables2=' + consumables2 + '&skills=' + btoa(encodeURIComponent(JSON.stringify(skills))) + '&flags=' + flags + '&camo=' + camouflage[0] +'&adrenalineValue1=' + adrenalineValue1 + '&adrenalineValue2=' + adrenalineValue2);
    });

    function setConsumables1()
    {
        if (list1 == null || ([[${warship1}]] != null && ([[${ship1}]] != warship1Name || [[${ship2}]] != warship2Name)))
        {
            list1 = [];
        }

        var notSelected = $('.button_consumable_1');
        var selected = $('.button_consumable_selected_1');

        if (selected.length > 0)
        {
            list1 = [];

            for (var i = 0; i < selected.length; i++)
            {
                list1.push(selected.eq(i).attr('name'));
            }
        }

        var allConsumables = [];
        for (var i = 0; i < notSelected.length; i++)
        {
            allConsumables.push(notSelected.eq(i).attr('name'));
        }
        for (var i = 0; i < selected.length; i++)
        {
            allConsumables.push(selected.eq(i).attr('name'));
        }

        var mismatch = true;
        for (var i = 0; i < list1.length; i++)
        {
            mismatch = true;

            for (var j = 0; j < allConsumables.length; j++)
            {
                if (list1[i] == allConsumables[j])
                {
                    mismatch = false;
                    break;
                }
            }

            if (mismatch)
            {
                list1 = [];
                break;
            }
        }

        consumables1 = [];
        for (var i = 0; i < list1.length; i++)
        {
            var current = list1[i];
            var abil = $('[name=' + current + ']').attr('class').split(' ')[1];

            $('[name=' + current + ']').attr('class', 'button_consumable_selected_1 ' + abil);
            consumables1.push(current);
            $('#' + current).removeAttr('style');
        }

        if ($('.button_consumable_selected_1').length == 0)
        {
            var abil0List = $('.button_consumable_1.abil0');
            var abil1List = $('.button_consumable_1.abil1');
            var abil2List = $('.button_consumable_1.abil2');
            var abil3List = $('.button_consumable_1.abil3');

            if (abil0List.length !== 0)
            {
                abil0List.eq(0).attr('class', 'button_consumable_selected_1 abil0');
                $('.consumablesStats1.abil0').eq(0).removeAttr('style');
            }

            if (abil1List.length !== 0)
            {
                abil1List.eq(0).attr('class', 'button_consumable_selected_1 abil1');
                $('.consumablesStats1.abil1').eq(0).removeAttr('style');
            }

            if (abil2List.length !== 0)
            {
                abil2List.eq(0).attr('class', 'button_consumable_selected_1 abil2');
                $('.consumablesStats1.abil2').eq(0).removeAttr('style');
            }

            if (abil3List.length !== 0)
            {
                abil3List.eq(0).attr('class', 'button_consumable_selected_1 abil3');
                $('.consumablesStats1.abil3').eq(0).removeAttr('style');
            }
        }

        history.replaceState({
            warship1: warship1Name,
            warship2: warship2Name
        }, warship1Name + warship2Name, live + '/shipStatComparison?ship1=' + encodeURIComponent(warship1Name) + '&ship2=' + encodeURIComponent(warship2Name) + '&modules1=' + modules1 + '&modules2=' + modules2 + '&upgrades1=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills1))) + '&upgrades2=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills2))) + '&consumables1=' + consumables1 + '&consumables2=' + consumables2 + '&skills=' + btoa(encodeURIComponent(JSON.stringify(skills))) + '&flags=' + flags + '&camo=' + camouflage[0] +'&adrenalineValue1=' + adrenalineValue1 + '&adrenalineValue2=' + adrenalineValue2);
    }

    function setConsumables2()
    {
        if (list2 == null || ([[${warship2}]] != null && ([[${ship1}]] != warship1Name || [[${ship2}]] != warship2Name)))
        {
            list2 = [];
        }

        var notSelected = $('.button_consumable_2');
        var selected = $('.button_consumable_selected_2');

        if (selected.length > 0)
        {
            list2 = [];

            for (var i = 0; i < selected.length; i++)
            {
                list2.push(selected.eq(i).attr('name'));
            }
        }

        var allConsumables = [];
        for (var i = 0; i < notSelected.length; i++)
        {
            allConsumables.push(notSelected.eq(i).attr('name'));
        }
        for (var i = 0; i < selected.length; i++)
        {
            allConsumables.push(selected.eq(i).attr('name'));
        }

        for (var i = 0; i < list2.length; i++)
        {
            var mismatch = true;

            for (var j = 0; j < allConsumables.length; j++)
            {
                if (list2[i] == allConsumables[j])
                {
                    mismatch = false;
                    break;
                }
            }

            if (mismatch)
            {
                list2 = [];
                break;
            }
        }

        consumables2 = [];
        for (var i = 0; i < list2.length; i++)
        {
            var current = list2[i];
            var abil = $('[name=' + current + ']').attr('class').split(' ')[1];

            $('[name=' + current + ']').attr('class', 'button_consumable_selected_2 ' + abil);
            consumables2.push(current);
            $('#' + current).removeAttr('style');
        }

        if ($('.button_consumable_selected_2').length == 0)
        {
            var abil0List = $('.button_consumable_2.abil0');
            var abil1List = $('.button_consumable_2.abil1');
            var abil2List = $('.button_consumable_2.abil2');
            var abil3List = $('.button_consumable_2.abil3');

            if (abil0List.length !== 0)
            {
                abil0List.eq(0).attr('class', 'button_consumable_selected_2 abil0');
                $('.consumablesStats2.abil0').eq(0).removeAttr('style');
            }

            if (abil1List.length !== 0)
            {
                abil1List.eq(0).attr('class', 'button_consumable_selected_2 abil1');
                $('.consumablesStats2.abil1').eq(0).removeAttr('style');
            }

            if (abil2List.length !== 0)
            {
                abil2List.eq(0).attr('class', 'button_consumable_selected_2 abil2');
                $('.consumablesStats2.abil2').eq(0).removeAttr('style');
            }

            if (abil3List.length !== 0)
            {
                abil3List.eq(0).attr('class', 'button_consumable_selected_2 abil3');
                $('.consumablesStats2.abil3').eq(0).removeAttr('style');
            }
        }

        history.replaceState({
            warship1: warship1Name,
            warship2: warship2Name
        }, warship1Name + warship2Name, live + '/shipStatComparison?ship1=' + encodeURIComponent(warship1Name) + '&ship2=' + encodeURIComponent(warship2Name) + '&modules1=' + modules1 + '&modules2=' + modules2 + '&upgrades1=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills1))) + '&upgrades2=' + btoa(encodeURIComponent(JSON.stringify(upgradesSkills2))) + '&consumables1=' + consumables1 + '&consumables2=' + consumables2 + '&skills=' + btoa(encodeURIComponent(JSON.stringify(skills))) + '&flags=' + flags + '&camo=' + camouflage[0] +'&adrenalineValue1=' + adrenalineValue1 + '&adrenalineValue2=' + adrenalineValue2);
    }

    //    ]]>
</script>
<!--Start of Tawk.to Script-->
<script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
        var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
        s1.async=true;
        s1.src='https://embed.tawk.to/5900f83364f23d19a89af69f/default';
        s1.charset='UTF-8';
        s1.setAttribute('crossorigin','*');
        s0.parentNode.insertBefore(s1,s0);
    })();
</script>
<!--End of Tawk.to Script-->
</body>
</html>